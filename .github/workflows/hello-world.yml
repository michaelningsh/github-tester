name: Hello World

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘

jobs:
  hello:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Say Hello
        run: echo "ðŸŽ‰ Hello, World! GitHub Actions is working!"

  simulate-fetch-rpms:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gpu-driver: [true, false]
    outputs:
      result: ${{ steps.export-result.outputs.result }}

    steps:
      - name: Checkout repository # å¿…é¡»å…ˆæ£€å‡ºä»“åº“æ‰èƒ½è®¿é—®æ–‡ä»¶
        uses: actions/checkout@v4

      - name: Prepare dynamic variables and select file
        id: prep
        run: |
          if [[ "${{ matrix.gpu-driver }}" == "true" ]]; then
            echo "selected_file_path=os-updates.yaml" >> $GITHUB_OUTPUT # å‡è®¾æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•
          else
            echo "selected_file_path=os-updates--no-gpu.yaml" >> $GITHUB_OUTPUT # å‡è®¾æ–‡ä»¶åœ¨ä»“åº“æ ¹ç›®å½•
          fi
          # åŒæ—¶è¾“å‡ºæ–‡ä»¶åï¼ˆä¸å«è·¯å¾„ï¼‰ï¼Œä»¥ä¾¿åŽç»­ JSON ä½¿ç”¨
          echo "output_file=$(basename ${{ steps.prep.outputs.selected_file_path }})" >> $GITHUB_OUTPUT

      - name: Verify selected file exists
        run: |
          echo "é€‰æ‹©çš„æ–‡ä»¶è·¯å¾„ï¼š${{ steps.prep.outputs.selected_file_path }}"
          if [ -f "${{ steps.prep.outputs.selected_file_path }}" ]; then
            echo "æ–‡ä»¶å­˜åœ¨ï¼å†…å®¹é¢„è§ˆï¼š"
            cat ${{ steps.prep.outputs.selected_file_path }}
          else
            echo "é”™è¯¯ï¼šæ–‡ä»¶ '${{ steps.prep.outputs.selected_file_path }}' ä¸å­˜åœ¨ï¼"
            exit 1
          fi

      - name: ç¼–ç æ–‡ä»¶å¹¶è®¾ç½®ä¸ºè¾“å‡º
        id: export-result
        run: |
          # ä»Žé€‰æ‹©çš„æ–‡ä»¶è·¯å¾„è¯»å–å†…å®¹å¹¶è¿›è¡Œ Base64 ç¼–ç 
          ENCODED_STRING=$(base64 -w 0 "${{ steps.prep.outputs.selected_file_path }}")
          # ä½¿ç”¨ jq åˆ›å»ºä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æ–‡ä»¶åå’Œ Base64 ç¼–ç åŽçš„æ–‡ä»¶å†…å®¹
          JSON_PAYLOAD=$(jq -cn --arg name "${{ steps.prep.outputs.output_file }}" --arg content "$ENCODED_STRING" '{file_name: $name, file_content_base_64: $content}')
          # å°† JSON è´Ÿè½½è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡º
          echo "result=$JSON_PAYLOAD" >> $GITHUB_OUTPUT