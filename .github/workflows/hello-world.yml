name: Hello World

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘

jobs:
  hello:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Say Hello
        run: echo "ğŸ‰ Hello, World! GitHub Actions is working!"

  simulate-fetch-rpms:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gpu-driver: [true, false]
    outputs:
      result: ${{ steps.export-result.outputs.result }}

    steps:
      - name: Prepare dynamic variables
        id: prep
        run: |
          if [[ "${{ matrix.gpu-driver }}" == "true" ]]; then
            echo "output_file=os-updates.yaml" >> $GITHUB_OUTPUT
          else
            echo "output_file=os-updates--no-gpu.yaml" >> $GITHUB_OUTPUT
          fi

      - name: Create dummy YAML file content
        run: |
          if [[ "${{ matrix.gpu-driver }}" == "true" ]]; then
            # åŒ…å« GPU é©±åŠ¨çš„ os-updates.yaml å†…å®¹
            cat << 'EOF' > ${{ steps.prep.outputs.output_file }}
updates:
  - name: kernel-default
    version: 6.4.0
  - name: xz
    version: 5.4.3
EOF
          else
            # ä¸åŒ…å« GPU é©±åŠ¨çš„ os-updates--no-gpu.yaml å†…å®¹
            cat << 'EOF' > ${{ steps.prep.outputs.output_file }}
updates:
  - name: coreutils
    version: "9.4"
  - name: zypper-needs-restarting
    version: 1.14.93
EOF
          fi
      - name: Verify file was created in this matrix job
        run: |
          echo "æ–‡ä»¶åœ¨æ­¤çŸ©é˜µä½œä¸šä¸­å·²åˆ›å»ºï¼š"
          ls -l ${{ steps.prep.outputs.output_file }}

      - name: ç¼–ç æ–‡ä»¶å¹¶è®¾ç½®ä¸ºè¾“å‡º
        id: export-result
        run: |
          # å°†æ–‡ä»¶å†…å®¹è¿›è¡Œ Base64 ç¼–ç ï¼Œ-w 0 è¡¨ç¤ºä¸æ¢è¡Œ
          ENCODED_STRING=$(base64 -w 0 ${{ steps.prep.outputs.output_file }})
          # ä½¿ç”¨ jq åˆ›å»ºä¸€ä¸ª JSON å­—ç¬¦ä¸²ï¼ŒåŒ…å«æ–‡ä»¶åå’Œ Base64 ç¼–ç åçš„æ–‡ä»¶å†…å®¹
          JSON_PAYLOAD=$(jq -cn --arg name "${{ steps.prep.outputs.output_file }}" --arg content "$ENCODED_STRING" '{file_name: $name, file_content_base_64: $content}')
          # å°† JSON è´Ÿè½½è®¾ç½®ä¸ºæ­¤æ­¥éª¤çš„è¾“å‡ºï¼Œä»¥ä¾¿å…¶ä»–ä½œä¸šå¯ä»¥è®¿é—®
          echo "result=$JSON_PAYLOAD" >> $GITHUB_OUTPUT