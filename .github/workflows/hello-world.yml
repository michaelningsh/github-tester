name: Hello World

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘

jobs:
  hello:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Say Hello
        run: echo "ğŸ‰ Hello, World! GitHub Actions is working!"

  fetch-rpms:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        gpu-driver: [true, false]
    # REMOVED: ä¸å†éœ€è¦ä½¿ç”¨ job outputs æ¥ä¼ é€’æ–‡ä»¶å†…å®¹
    # outputs:
    #   result_gpu:   ${{ matrix.gpu-driver == 'true' && steps.export-result.outputs.output_content || '' }}
    #   result_nogpu: ${{ matrix.gpu-driver == 'false' && steps.export-result.outputs.output_content || '' }}
    steps:
      - name: Checkout # å¿…é¡»å…ˆæ£€å‡ºä»“åº“æ‰èƒ½è®¿é—®æ¨¡æ‹Ÿæ–‡ä»¶
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libguestfs-tools tree jq

      - name: Prepare dynamic variables
        id: prep
        run: |
          if [[ "${{ matrix.gpu-driver }}" == "true" ]]; then
            SUFFIX=""
            TYPE="gpu"
            echo "initial_os_updates_yaml=./os-updates.yaml" >> $GITHUB_OUTPUT
            echo "mock_updates_xml=./mock_data/updates_gpu.xml" >> $GITHUB_OUTPUT
          else
            SUFFIX="--no-gpu"
            TYPE="no-gpu"
            echo "initial_os_updates_yaml=./os-updates--no-gpu.yaml" >> $GITHUB_OUTPUT
            echo "mock_updates_xml=./mock_data/updates_no_gpu.xml" >> $GITHUB_OUTPUT
          fi
          echo "image_suffix=${SUFFIX}" >> $GITHUB_OUTPUT
          echo "image_type=${TYPE}" >> $GITHUB_OUTPUT
          echo "base_image=lws-base-image${SUFFIX}" >> $GITHUB_OUTPUT
          echo "output_file=os-updates${SUFFIX}.yaml" >> $GITHUB_OUTPUT

      - name: Prepare workdir
        run: |
          mkdir -p ./tmp/${{ steps.prep.outputs.image_type }}/output
          cp ${{ steps.prep.outputs.initial_os_updates_yaml }} ./tmp/${{ steps.prep.outputs.image_type }}/${{ steps.prep.outputs.output_file }}

      - name: Simulate Run list-os-updates.sh in container (copy mock XML)
        run: |
          cp ${{ steps.prep.outputs.mock_updates_xml }} ./tmp/${{ steps.prep.outputs.image_type }}/output/updates.xml
          echo "[âœ“] Simulated. RPM update list is in tmp/${{ steps.prep.outputs.image_type }}/output/updates.xml"
          tree tmp/${{ steps.prep.outputs.image_type }}/

      - name: Convert new updates to Yaml
        id: convert
        uses: mikefarah/yq@v4.46.1
        with:
          cmd: |
            yq -px -oy '{"updates": [.stream.update-status.update-list.update[] | {"name": .["+@name"], "version": .["+@edition"] | split("-") | .[0] }]}' \
              tmp/${{ steps.prep.outputs.image_type }}/output/updates.xml
 
      - name: Save updates.yaml
        run: |
          echo '${{ steps.convert.outputs.result }}' > tmp/${{ steps.prep.outputs.image_type }}/output/updates.yaml
          tree tmp/${{ steps.prep.outputs.image_type }}/
            
      - name: Merge existing with new OS updates
        uses: mikefarah/yq@v4.46.1
        with:
          cmd: |
            idPath=".name"  originalPath=".updates"  otherPath=".updates" yq eval-all --inplace '
            (
              (( (eval(strenv(originalPath)) + eval(strenv(otherPath)))  | .[] | {(eval(strenv(idPath))):  .}) as $item ireduce ({}; . * $item )) as $uniqueMap
              | ( $uniqueMap  | to_entries | .[]) as $item ireduce([]; . + $item.value)
            ) as $mergedArray
            | select(fi == 0) | (eval(strenv(originalPath))) = $mergedArray
            ' tmp/${{ steps.prep.outputs.image_type }}/${{ steps.prep.outputs.output_file }} tmp/${{ steps.prep.outputs.image_type }}/output/updates.yaml

      - name: Print merged OS updates
        run: |
          echo "==== Merged OS Updates for ${{ steps.prep.outputs.image_type }} ===="
          cat tmp/${{ steps.prep.outputs.image_type }}/${{ steps.prep.outputs.output_file }}

      # --- ä¿®æ”¹éƒ¨åˆ† START ---
      # ç§»é™¤äº† "Encode merged YAML and set as job output" æ­¥éª¤
      # æ›¿æ¢ä¸ºä¸Šä¼ æ„ä»¶
      - name: Upload merged YAML as an artifact
        uses: actions/upload-artifact@v4
        with:
          # ä¸ºæ¯ä¸ªæ„ä»¶æä¾›ä¸€ä¸ªåŸºäºçŸ©é˜µå˜é‡çš„å”¯ä¸€åç§°
          name: os-updates-${{ steps.prep.outputs.image_type }}
          # æŒ‡å®šè¦ä¸Šä¼ çš„æ–‡ä»¶è·¯å¾„
          path: tmp/${{ steps.prep.outputs.image_type }}/${{ steps.prep.outputs.output_file }}
          # å¯é€‰ï¼šè®¾ç½®æ„ä»¶çš„ä¿ç•™å¤©æ•°
          retention-days: 1
      # --- ä¿®æ”¹éƒ¨åˆ† END ---


  create-pr:
    needs: [fetch-rpms]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- ä¿®æ”¹éƒ¨åˆ† START ---
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          # ä¸æŒ‡å®š nameï¼Œä¼šä¸‹è½½æœ¬æ¬¡å·¥ä½œæµç¨‹è¿è¡Œäº§ç”Ÿçš„æ‰€æœ‰æ„ä»¶
          # ä¸‹è½½çš„æ–‡ä»¶ä¼šå­˜æ”¾åœ¨æŒ‡å®šçš„ path ç›®å½•ä¸‹
          path: ./artifacts

      - name: Display downloaded artifacts structure
        run: |
          echo "Artifacts downloaded to ./artifacts"
          tree ./artifacts
          # é¢„æœŸç›®å½•ç»“æ„:
          # ./artifacts
          # â”œâ”€â”€ os-updates-gpu
          # â”‚   â””â”€â”€ os-updates.yaml
          # â””â”€â”€ os-updates-no-gpu
          #     â””â”€â”€ os-updates--no-gpu.yaml

      - name: Restore YAML files from artifacts
        run: |
          echo "Restoring YAML files to the working directory..."
          # å°†ä¸‹è½½çš„æ–‡ä»¶ä»å„è‡ªçš„å­ç›®å½•ç§»åŠ¨åˆ°æ ¹ç›®å½•ï¼Œä»¥ä¾¿åç»­æ­¥éª¤ä½¿ç”¨
          # ä½¿ç”¨ find å‘½ä»¤å¯ä»¥æ›´çµæ´»åœ°å¤„ç†æ–‡ä»¶
          find ./artifacts -type f -name "*.yaml" -exec mv {} . \;
          
          echo "Files in the current directory:"
          ls -l
      # --- ä¿®æ”¹éƒ¨åˆ† END ---
      
